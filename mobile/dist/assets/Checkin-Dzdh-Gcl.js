import"./index-BfNrj1Io.js";import{T as me,a as _e}from"./index-PtygPl2G.js";import{C as fe}from"./index-CcX8rTri.js";import{F as he}from"./index-DmReRFXi.js";import{B as pe}from"./index-ck5WoTsJ.js";import{_ as ye,o as ge,ao as ke,j as E,b as n,c as i,f as u,e as o,S as be,al as Q,t as h,an as we,w as p,g as X,am as F,ah as Z,ai as D,r as s,G as r,s as b}from"./index-DE8r4v9z.js";import{N as Ce}from"./index-QT4Twd0-.js";import{s as xe}from"./index-5LrtQatF.js";import"./use-placeholder-33bInLsI.js";const Se={class:"page-container"},Le={class:"checkin-content"},Ne={key:0,class:"loading-wrapper"},$e={class:"time-display"},De={class:"current-time"},Ie={class:"current-date"},Ve={key:0,class:"rest-day"},ze={class:"rest-image"},Oe={class:"rest-hint"},Ae={class:"checkin-button-wrapper"},Be={key:1,class:"button-inner"},Ee={class:"button-text"},Fe={class:"button-time"},He={class:"today-status card"},Te={class:"status-row"},Pe={class:"status-item"},Me={key:0,class:"status-tag late"},Ue={class:"status-item"},Re={key:0,class:"status-tag early"},je={class:"location-info card"},Ge={key:0},Je={key:1,class:"error"},We={key:2},Ke={key:0,class:"location-hint"},ee="hr_mobile_location_cache_v1",Ye=10*60*1e3,qe={__name:"Checkin",setup(Qe){const H=s(1),O=s(""),T=s("");let A=null;const _=s(null),k=s(null),x=s(""),y=s(!0),S=s(!1),m=s("");function te(){try{const e=localStorage.getItem(ee);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"||typeof t.lat!="number"||typeof t.lng!="number"||typeof t.ts!="number"||Date.now()-t.ts>Ye?null:t}catch{return null}}function ae(e,t){try{localStorage.setItem(ee,JSON.stringify({lat:e,lng:t,ts:Date.now()}))}catch{}}const B=s(!1),g=s(null),L=s(""),P=s(!0),N=s(!0),M=s(""),l=r(()=>{var e;return!!((e=g.value)!=null&&e.check_in_time)}),$=r(()=>{var e;return!!((e=g.value)!=null&&e.check_out_time)}),U=r(()=>{var e,t;return((t=(e=g.value)==null?void 0:e.check_in_time)==null?void 0:t.slice(0,5))||""}),R=r(()=>{var e,t;return((t=(e=g.value)==null?void 0:e.check_out_time)==null?void 0:t.slice(0,5))||""}),oe=r(()=>{var e;return((e=g.value)==null?void 0:e.attendance_type)==="late"}),se=r(()=>{var e;return((e=g.value)==null?void 0:e.attendance_type)==="early_leave"}),le=r(()=>(l.value&&$.value||l.value,"attendance")),ne=r(()=>l.value&&$.value?"更新签退":l.value?"下班签退":"上班签到"),ue=r(()=>l.value&&$.value?"status-completed":l.value?"status-working":"status-start"),j=r(()=>{const e=new Date,t=e.getHours(),v=e.getMinutes();return l.value?$.value?!1:t<18:t>9||t===9&&v>0}),ce=r(()=>l.value?"早退原因":"迟到原因"),G=r(()=>l.value?"请填写早退原因":"请填写迟到原因");ge(()=>{J(),A=setInterval(J,1e3),W(),ie(),ve()}),ke(()=>{A&&clearInterval(A)});async function ie(){try{const e=await E.get("/api/attendance/workday/");e.data.success&&(N.value=e.data.data.is_workday,M.value=e.data.data.holiday_name||"")}catch{const t=new Date().getDay();N.value=t!==0&&t!==6}finally{P.value=!1}}function re(){xe({title:"加班打卡",message:"今日为休息日，确定要进行加班打卡吗？"}).then(()=>{N.value=!0}).catch(()=>{})}function J(){const e=new Date;O.value=e.toTimeString().slice(0,8);const t=["周日","周一","周二","周三","周四","周五","周六"];T.value=`${e.getMonth()+1}月${e.getDate()}日 ${t[e.getDay()]}`}function W(){y.value=!0,m.value="",S.value=!1;const e=te(),t=!!e;e&&(_.value=e.lat,k.value=e.lng,x.value=`上次位置 ${e.lat.toFixed(4)}, ${e.lng.toFixed(4)}`,y.value=!1,S.value=!0);const v=window.isSecureContext||location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1";if(!navigator.geolocation){m.value="浏览器不支持定位",y.value=!1;return}if(!v){console.warn("非 HTTPS 环境，无法使用精确定位"),x.value="定位不可用（非HTTPS）",y.value=!1,_.value=0,k.value=0;return}const a=f=>{_.value=f.coords.latitude,k.value=f.coords.longitude,y.value=!1,S.value=!1,x.value=`${_.value.toFixed(4)}, ${k.value.toFixed(4)}`,ae(_.value,k.value)},d=f=>{if(y.value=!1,S.value=!1,!t){switch(f.code){case 1:m.value="请允许获取位置权限";break;case 2:m.value="无法获取位置信息";break;case 3:m.value="获取位置超时";break;default:m.value="获取位置失败"}_.value||(_.value=22.5431,k.value=114.0579,x.value="默认位置",m.value="")}};navigator.geolocation.getCurrentPosition(a,()=>{navigator.geolocation.getCurrentPosition(a,d,{enableHighAccuracy:!0,timeout:6e3,maximumAge:6e4})},{enableHighAccuracy:!1,timeout:1500,maximumAge:10*60*1e3})}async function ve(){try{const e=await E.get("/api/attendance/today/");e.data.success&&(g.value=e.data.data)}catch(e){console.error(e)}}async function de(){var d,f,I,V,w,z,c,K,Y;if(y.value){b({message:"正在获取位置，请稍候",duration:1500});return}if(m.value&&_.value===null){b({message:"请先允许获取位置",icon:"warning-o"}),W();return}if(j.value&&!L.value.trim()){b({message:G.value,position:"top"});return}const e=l.value&&$.value,t=l.value?"check_out":"check_in";let v="签到";l.value&&(v=e?"更新签退":"签退"),B.value=!0;const a=b({type:"loading",message:`${v}中...`,duration:0,forbidClick:!0});try{const C=await E.post("/api/attendance/check/",{action:t,latitude:_.value,longitude:k.value,notes:L.value.trim()});C.data.success?((d=a==null?void 0:a.close)==null||d.call(a),b({type:"success",message:`${v}成功`,duration:1500}),g.value=C.data.data,L.value=""):((f=a==null?void 0:a.close)==null||f.call(a),b(((I=C.data.error)==null?void 0:I.message)||`${v}失败`))}catch(C){const q=(V=C.response)==null?void 0:V.status;(!q||![401,403,404,500].includes(q))&&((w=a==null?void 0:a.close)==null||w.call(a),b(((K=(c=(z=C.response)==null?void 0:z.data)==null?void 0:c.error)==null?void 0:K.message)||`${v}失败`))}finally{(Y=a==null?void 0:a.close)==null||Y.call(a),B.value=!1}}return(e,t)=>{const v=Ce,a=be,d=we,f=pe,I=he,V=fe,w=me,z=_e;return n(),i("div",Se,[u(v,{title:"签到打卡","left-arrow":"",onClickLeft:t[0]||(t[0]=c=>e.$router.back())}),o("div",Le,[P.value?(n(),i("div",Ne,[u(a,{size:"32"})])):(n(),i(Q,{key:1},[o("div",$e,[o("div",De,h(O.value),1),o("div",Ie,h(T.value),1)]),!N.value&&!l.value?(n(),i("div",Ve,[o("div",ze,[u(d,{name:"leaves",size:"80",color:"#a0cfff"})]),t[4]||(t[4]=o("div",{class:"rest-text"},"今日休息",-1)),o("div",Oe,h(M.value||"周末愉快"),1),u(f,{type:"primary",plain:"",round:"",size:"small",style:{"margin-top":"20px"},onClick:re},{default:p(()=>[...t[3]||(t[3]=[X(" 加班打卡 ",-1)])]),_:1})])):N.value||l.value?(n(),i(Q,{key:1},[o("div",Ae,[o("div",{class:F(["checkin-button",ue.value]),onClick:de},[B.value?(n(),Z(a,{key:0,color:"#fff",size:"32"})):(n(),i("div",Be,[u(d,{name:le.value,size:"48",color:"#fff"},null,8,["name"]),o("span",Ee,h(ne.value),1),o("span",Fe,h(O.value.slice(0,5)),1)]))],2)]),o("div",He,[o("div",Te,[o("div",Pe,[t[5]||(t[5]=o("div",{class:"status-label"},"上班签到",-1)),o("div",{class:F(["status-value",{"has-value":U.value}])},h(U.value||"--:--"),3),oe.value?(n(),i("div",Me,"迟到")):D("",!0)]),t[7]||(t[7]=o("div",{class:"status-divider"},null,-1)),o("div",Ue,[t[6]||(t[6]=o("div",{class:"status-label"},"下班签退",-1)),o("div",{class:F(["status-value",{"has-value":R.value}])},h(R.value||"--:--"),3),se.value?(n(),i("div",Re,"早退")):D("",!0)])])]),o("div",je,[u(d,{name:"attendance",color:"#1989fa"}),y.value?(n(),i("span",Ge,"正在获取位置...")):m.value?(n(),i("span",Je,h(m.value),1)):(n(),i("span",We,[X(h(x.value||"已获取位置")+" ",1),S.value?(n(),i("span",Ke,"（更新中）")):D("",!0)]))]),j.value?(n(),Z(V,{key:0,inset:"",style:{"margin-top":"16px"}},{default:p(()=>[u(I,{modelValue:L.value,"onUpdate:modelValue":t[1]||(t[1]=c=>L.value=c),type:"textarea",label:ce.value,placeholder:G.value,rows:"2",maxlength:"200","show-word-limit":""},null,8,["modelValue","label","placeholder"])]),_:1})):D("",!0)],64)):D("",!0)],64))]),u(z,{modelValue:H.value,"onUpdate:modelValue":t[2]||(t[2]=c=>H.value=c),fixed:""},{default:p(()=>[u(w,{to:"/home"},{icon:p(({active:c})=>[u(d,{name:"dashboard",color:c?"#1989fa":"#646566",size:"20"},null,8,["color"])]),default:p(()=>[t[8]||(t[8]=o("span",null,"首页",-1))]),_:1}),u(w,{to:"/checkin"},{icon:p(({active:c})=>[u(d,{name:"attendance",color:c?"#1989fa":"#646566",size:"20"},null,8,["color"])]),default:p(()=>[t[9]||(t[9]=o("span",null,"打卡",-1))]),_:1}),u(w,{to:"/me"},{icon:p(({active:c})=>[u(d,{name:"account",color:c?"#1989fa":"#646566",size:"20"},null,8,["color"])]),default:p(()=>[t[10]||(t[10]=o("span",null,"我的",-1))]),_:1})]),_:1},8,["modelValue"])])}}},ut=ye(qe,[["__scopeId","data-v-ab4239e7"]]);export{ut as default};
